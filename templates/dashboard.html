{% extends "base.html" %}

{% block head_extra %}
<style>
    .dashboard-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 1.5rem;
        margin-top: 1.5rem;
        height: calc(100vh - 150px);
    }

    @media (max-width: 992px) {
        .dashboard-container {
            grid-template-columns: 1fr;
            height: auto;
        }
    }

    .main-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .panel-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 1.75rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .panel-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .panel-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .panel-title i {
        color: var(--primary);
    }

    /* Upload Area */
    .upload-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .upload-area {
        border: 2px dashed var(--glass-border);
        border-radius: 16px;
        padding: 3rem 2rem;
        text-align: center;
        background: rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .upload-area:hover,
    .upload-area.dragover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 4rem;
        color: var(--text-gray);
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .upload-area:hover .upload-icon {
        color: var(--primary);
        transform: scale(1.1);
    }

    .upload-text h3 {
        font-size: 1.5rem;
        margin-bottom: 0.75rem;
        color: var(--text-light);
    }

    .upload-text p {
        color: var(--text-gray);
        font-size: 1rem;
        margin-bottom: 1.5rem;
    }

    #fileInput {
        display: none;
    }

    /* Results Section */
    .results-section {
        display: none;
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .defect-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .defect-name {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary);
        margin: 0;
    }

    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.25rem;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        width: fit-content;
    }

    .images-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {
        .images-comparison {
            grid-template-columns: 1fr;
        }
    }

    .image-container {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 1;
        background: #000;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
    }

    .image-container:hover {
        transform: scale(1.03);
    }

    .image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: opacity 0.3s ease;
    }

    .image-label {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        padding: 0.75rem;
        font-size: 0.9rem;
        text-align: center;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .image-label i {
        color: var(--primary);
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    @media (max-width: 576px) {
        .action-buttons {
            flex-direction: column;
        }
    }

    /* History Panel */
    .history-list {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .history-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.2);
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .history-item:hover {
        background: rgba(99, 102, 241, 0.2);
        transform: translateX(5px);
    }

    .history-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .history-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .history-details {
        flex: 1;
    }

    .history-defect {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .history-date {
        font-size: 0.8rem;
        color: var(--text-gray);
    }

    .history-confidence {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary);
    }

    /* Chatbot */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }

    .message {
        max-width: 85%;
        padding: 1rem;
        border-radius: 16px;
        line-height: 1.5;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .message.bot {
        background: rgba(255, 255, 255, 0.1);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }

    .chat-input-area {
        display: flex;
        gap: 0.75rem;
    }

    .chat-input-area input {
        flex: 1;
        padding: 0.875rem 1.25rem;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        background: rgba(0, 0, 0, 0.3);
        color: white;
        outline: none;
        transition: all 0.3s ease;
    }

    .chat-input-area input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    /* Loading */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 16px;
        display: none;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 1.1rem;
        font-weight: 500;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-gray);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--text-muted);
    }

    .empty-state p {
        margin: 0;
    }

    /* Scrollbar */
    .history-list::-webkit-scrollbar,
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .history-list::-webkit-scrollbar-track,
    .chat-messages::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb,
    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="font-size: 2rem; font-weight: 800;">AI Fabric Defect Detector</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span style="color: var(--text-gray); background: rgba(0, 0, 0, 0.3); padding: 0.5rem 1rem; border-radius: 20px;">
                <i class="fas fa-user-astronaut"></i> Welcome, {{ user }}
            </span>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Main Content Panel -->
        <div class="main-panel">
            <!-- Upload & Analysis Card -->
            <div class="panel-card">
                <h2 class="panel-title">
                    <i class="fas fa-camera"></i>
                    Image Analysis
                </h2>

                <div class="upload-container">
                    <div class="upload-area" id="uploadDropzone">
                        <div class="loading-overlay" id="uploadLoader">
                            <div class="spinner"></div>
                            <div class="loading-text">Analyzing your fabric...</div>
                        </div>

                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <div class="upload-text">
                            <h3>Drag & Drop or Click to Upload</h3>
                            <p>Supports JPG, PNG formats (Max 5MB)</p>
                        </div>
                        <button class="btn btn-primary" style="margin: 0 auto;">
                            <i class="fas fa-folder-open"></i> Select Image
                        </button>
                        <input type="file" id="fileInput" accept="image/*">
                    </div>

                    <!-- Results Section -->
                    <div class="results-section" id="resultsSection">
                        <div class="results-header">
                            <div class="defect-info">
                                <h3 class="defect-name" id="defectName">Detecting...</h3>
                                <div class="confidence-badge">
                                    <i class="fas fa-chart-line"></i>
                                    <span id="confidenceScore">Confidence: 0%</span>
                                </div>
                            </div>
                            <button class="btn btn-outline" onclick="resetAnalysis()">
                                <i class="fas fa-redo"></i> New Analysis
                            </button>
                        </div>

                        <div class="images-comparison">
                            <div class="image-container">
                                <img id="originalImg" src="" alt="Original Fabric">
                                <div class="image-label">
                                    <i class="fas fa-image"></i> Original Image
                                </div>
                            </div>
                            <div class="image-container">
                                <img id="resultImg" src="" alt="Defect Analysis">
                                <div class="image-label">
                                    <i class="fas fa-brain"></i> AI Analysis
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="askAboutDefect()" style="flex: 1;">
                                <i class="fas fa-comment-medical"></i> Get Treatment Advice
                            </button>
                            <button class="btn btn-outline" onclick="downloadResult()" style="flex: 1;">
                                <i class="fas fa-download"></i> Save Report
                            </button>
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0, 0, 0, 0.2); border-radius: 12px; font-size: 0.9rem;">
                            <p style="margin: 0; display: flex; align-items: flex-start; gap: 0.75rem;">
                                <i class="fas fa-info-circle" style="color: var(--primary); margin-top: 0.25rem;"></i>
                                <span>The heatmap highlights defect regions using Grad-CAM technology for precise localization.</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Card -->
            <div class="panel-card">
                <h2 class="panel-title">
                    <i class="fas fa-history"></i>
                    Recent Analyses
                </h2>

                <div class="history-list" id="historyList">
                    <div class="empty-state" id="historyEmpty">
                        <i class="fas fa-inbox"></i>
                        <p>No analysis history yet</p>
                    </div>
                    <!-- History items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Sidebar Panel -->
        <div class="panel-card" style="height: fit-content;">
            <h2 class="panel-title">
                <i class="fas fa-robot"></i>
                AI Assistant
            </h2>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        ðŸ‘‹ Hello! I'm FabricAI, your textile quality expert.
                        <br><br>
                        Upload a fabric image for defect analysis, or ask me anything about textile manufacturing!
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Ask about defects, treatments, or textile tech..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const dropzone = document.getElementById('uploadDropzone');
    const fileInput = document.getElementById('fileInput');
    const uploadLoader = document.getElementById('uploadLoader');
    const resultsSection = document.getElementById('resultsSection');
    const historyList = document.getElementById('historyList');
    const historyEmpty = document.getElementById('historyEmpty');

    let currentDefect = null;
    let analysisHistory = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadHistory();
    });

    // Upload & Drag-Drop Logic
    dropzone.addEventListener('click', () => fileInput.click());

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) { 
        e.preventDefault(); 
        e.stopPropagation(); 
    }

    dropzone.addEventListener('dragover', () => dropzone.classList.add('dragover'));
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));

    dropzone.addEventListener('drop', (e) => {
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) handleFiles(files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        if (fileInput.files.length) handleFiles(fileInput.files[0]);
    });

    function handleFiles(file) {
        // Validate file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!validTypes.includes(file.type)) {
            alert('Please upload a valid image file (JPG, JPEG, or PNG)');
            return;
        }

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size exceeds 5MB limit');
            return;
        }

        // 1. Upload File
        const formData = new FormData();
        formData.append('file', file);

        uploadLoader.style.display = 'flex';
        resultsSection.style.display = 'none';

        fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    runPrediction(data.filepath);
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                    uploadLoader.style.display = 'none';
                }
            })
            .catch(err => {
                console.error(err);
                alert('Upload error: ' + err.message);
                uploadLoader.style.display = 'none';
            });
    }

    function runPrediction(filepath) {
        fetch('/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filepath: filepath })
        })
            .then(res => res.json())
            .then(data => {
                uploadLoader.style.display = 'none';
                
                if (data.status === 'rejected') {
                    alert(data.message);
                    return;
                }
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Show Results
                document.getElementById('defectName').innerText = data.class_name;
                document.getElementById('confidenceScore').innerText = 'Confidence: ' + data.confidence;
                document.getElementById('originalImg').src = data.original_url;
                document.getElementById('resultImg').src = data.result_url;

                currentDefect = data.class_name;
                resultsSection.style.display = 'block';

                // Add to history
                addToHistory({
                    defect: data.class_name,
                    confidence: data.confidence,
                    originalUrl: data.original_url,
                    resultUrl: data.result_url,
                    timestamp: new Date().toISOString()
                });

                // Auto add to chat
                addMessage('bot', `ðŸ”¬ I detected <strong>${data.class_name}</strong> with ${data.confidence} confidence. Would you like to know how to treat this defect? Just ask!`);
            })
            .catch(err => {
                uploadLoader.style.display = 'none';
                alert('Prediction error: ' + err.message);
            });
    }

    // History Management
    function addToHistory(item) {
        analysisHistory.unshift(item);
        // Keep only the last 10 items
        if (analysisHistory.length > 10) {
            analysisHistory.pop();
        }
        saveHistory();
        renderHistory();
    }

    function saveHistory() {
        localStorage.setItem('fabricAnalysisHistory', JSON.stringify(analysisHistory));
    }

    function loadHistory() {
        const saved = localStorage.getItem('fabricAnalysisHistory');
        if (saved) {
            analysisHistory = JSON.parse(saved);
            renderHistory();
        }
    }

    function renderHistory() {
        if (analysisHistory.length === 0) {
            historyEmpty.style.display = 'block';
            historyList.innerHTML = '';
            return;
        }

        historyEmpty.style.display = 'none';
        historyList.innerHTML = '';

        analysisHistory.forEach((item, index) => {
            const date = new Date(item.timestamp);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div class="history-image">
                    <img src="${item.resultUrl}" alt="${item.defect}">
                </div>
                <div class="history-details">
                    <div class="history-defect">${item.defect}</div>
                    <div class="history-date">${formattedDate}</div>
                </div>
                <div class="history-confidence">${item.confidence}</div>
            `;
            
            historyItem.addEventListener('click', () => {
                // Show this item in the results section
                document.getElementById('defectName').innerText = item.defect;
                document.getElementById('confidenceScore').innerText = 'Confidence: ' + item.confidence;
                document.getElementById('originalImg').src = item.originalUrl;
                document.getElementById('resultImg').src = item.resultUrl;
                currentDefect = item.defect;
                resultsSection.style.display = 'block';
                
                // Scroll to results
                document.querySelector('.panel-card').scrollIntoView({ behavior: 'smooth' });
            });
            
            historyList.appendChild(historyItem);
        });
    }

    function resetAnalysis() {
        resultsSection.style.display = 'none';
        fileInput.value = '';
        dropzone.classList.remove('dragover');
    }

    // Chat Logic
    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;

        addMessage('user', text);
        input.value = '';

        fetch('/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: text,
                currentDefect: currentDefect
            })
        })
            .then(res => res.json())
            .then(data => {
                addMessage('bot', data.reply);
            })
            .catch(err => {
                addMessage('bot', 'Sorry, I encountered an error. Please try again.');
                console.error('Chat error:', err);
            });
    }

    function addMessage(sender, text) {
        const chatMessages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = text; // Allow HTML for formatting
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function askAboutDefect() {
        if (currentDefect) {
            const query = `How can I treat or fix ${currentDefect}?`;
            document.getElementById('chatInput').value = query;
            sendMessage();
        }
    }

    function downloadResult() {
        alert('Report saving feature would be implemented here.');
        // In a real implementation, this would generate and download a PDF report
    }
</script>
{% endblock %}